<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>MODIS processing with R, GDAL, and the NCO tools &#8211; Adam Michael Wilson, Ph.D.</title>
<meta name="description" content="Open-source tools for MODIS processing">
<meta name="keywords" content="research">



<!-- Twitter Cards -->
<meta name="twitter:title" content="MODIS processing with R, GDAL, and the NCO tools">
<meta name="twitter:description" content="Open-source tools for MODIS processing">
<meta name="twitter:site" content="@planetflux">
<meta name="twitter:creator" content="@planetflux">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://adammwilson.github.io//images/logos/ian-symbol-wake-turbulence_icon-01.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="MODIS processing with R, GDAL, and the NCO tools">
<meta property="og:description" content="Open-source tools for MODIS processing">
<meta property="og:url" content="http://adammwilson.github.io//blog/MODIS-processing-with-R,-GDAL-and-the-NCO-tools/">
<meta property="og:site_name" content="Adam Michael Wilson, Ph.D.">





<link rel="canonical" href="http://adammwilson.github.io//blog/MODIS-processing-with-R,-GDAL-and-the-NCO-tools/">
<link href="http://adammwilson.github.io//feed.xml" type="application/atom+xml" rel="alternate" title="Adam Michael Wilson, Ph.D. Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://adammwilson.github.io//assets/css/main.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://adammwilson.github.io//assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://adammwilson.github.io//assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://adammwilson.github.io//assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://adammwilson.github.io//favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://adammwilson.github.io//favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://adammwilson.github.io//images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://adammwilson.github.io//images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://adammwilson.github.io//images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://adammwilson.github.io//images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		        
		    
		    <li><a href="http://adammwilson.github.io//people.html" >People</a></li>
		  
		    
		        
		    
		    <li><a href="http://adammwilson.github.io//research/" >Research</a></li>
		  
		    
		        
		    
		    <li><a href="http://adammwilson.github.io//publications/" >Publications</a></li>
		  
		    
		        
		    
		    <li><a href="http://adammwilson.github.io//blog/" >Blog</a></li>
		  
		    
		        
		    
		    <li><a href="http://adammwilson.github.io//photo/" >Photography</a></li>
		  
		    
		        
		    
		    <li><a href="http://adammwilson.github.io//search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
        
    		<a href="http://adammwilson.github.io//" class="site-logo" rel="home" title="Adam Michael Wilson, Ph.D."><img src="http://adammwilson.github.io//images/logos/ian-symbol-wake-turbulence_icon-01.png" width="200" height="200" alt="Adam Michael Wilson, Ph.D. logo" class="animated fadeInUp"></a>
        
        <h1 class="site-title animated fadeIn"><a href="http://adammwilson.github.io//">Adam Michael Wilson, Ph.D.</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Studying Ecological Change in a Changing World</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>

<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="http://adammwilson.github.io//tags/#research" title="Pages tagged research">research</a></span>
        
          <h1 class="entry-title">MODIS processing with R, GDAL, and the NCO tools</h1>
        
      </header>
      <footer class="entry-meta">
        
        
        
          <img src="http://adammwilson.github.io//images/bio-photo.jpg" class="bio-photo" alt="Adam M. Wilson bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Adam M. Wilson</span></span>
        <span class="entry-date date published"><time datetime="2010-06-03T00:00:00-04:00"><i class="fa fa-calendar-o"></i> June 03, 2010</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=research&amp;text=MODIS%20processing%20with%20R,%20GDAL,%20and%20the%20NCO%20tools&amp;url=http://adammwilson.github.io//blog/MODIS-processing-with-R,-GDAL-and-the-NCO-tools/&amp;via=planetflux" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=http://adammwilson.github.io//blog/MODIS-processing-with-R,-GDAL-and-the-NCO-tools/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=http://adammwilson.github.io//blog/MODIS-processing-with-R,-GDAL-and-the-NCO-tools/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <p>I use MODIS data for analysis of vegetation dynamics around the world.  The native HDF file format provided by NASA is great for archiving the data (it’s amazing how much information they include in each file), but unfortunately there aren’t many tools for directly (and easily) extracting data stored across files like there are for the NetCDF format.  I wanted to be able to use the NCO tools to extract timeseries of a sub-setted region stored in many files.  This is quite easy with the ncrcat and similar NCO utilities.  The trouble is that the NCO tools require the data to be in netcdf3 or netcdf-4 classic to do this. I triedto use various HDF-&gt;netCDF conversion tools but eventually decided it was easiest to convert HDF-&gt;geotiff-&gt;netcdf.  The hierarchical nature of the HDF files makes them difficult to parse and so far the netcdf tools are not able to work with them unless they are ‘flattened’ to a single group.</p>

<p>So to use the NCO tools with MODIS data, I had to develop a processing routine that will convert them to netcdf-4 classic format.  This post will show you how.</p>

<p>I generally use R for my data processing and workflow scripting, though much of this could be done with shell scripting or other languages.  The code below is specific to my situation and will almost certainly require some editing if you want to use it.  I’m posting it to serve as general guidelines on how one might do this, not as a ready to use and generally applicable set of functions. I appreciate any suggestions on improvements.</p>

<p>First you need to identify which tiles you need by looking at the map:</p>

<p>Then run something like this to download the entire MOD13Q1 (vegetation indices) data from MODIS.  Get ready for lots of data (the following list of tiles results in 269GB!):</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">### Some specifications  </span>
 ftpsite<span class="o">=</span><span class="s">&quot;ftp://e4ftl01u.ecs.nasa.gov/MOLT/MOD13Q1.005/&quot;</span> <span class="c1">#for veg index  </span>
 hdffolder<span class="o">=</span><span class="s">&quot;1_HDF&quot;</span> <span class="c1">#folder to hold HDF files  </span>
 ofolder<span class="o">=</span><span class="s">&quot;2_netcdf&quot;</span> <span class="c1">#this is where the output NetCDF files will go  </span>
 bandsubset<span class="o">=</span><span class="kp">paste</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="c1">#keep only these bands from HDF file  </span>
 regionbounds<span class="o">=</span><span class="s">&quot;49 113 30 146&quot;</span> <span class="c1"># Set region boundaries for clipping  </span>
 <span class="c1">## Get tiles to download - get these from the map  </span>
 tiles<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;h25v04&quot;</span><span class="p">,</span><span class="s">&quot;h26v04&quot;</span><span class="p">,</span><span class="s">&quot;h26v05&quot;</span><span class="p">,</span><span class="s">&quot;h27v04&quot;</span><span class="p">,</span><span class="s">&quot;h28v04&quot;</span><span class="p">,</span><span class="s">&quot;h27v05&quot;</span><span class="p">,</span><span class="s">&quot;h28v05&quot;</span><span class="p">,</span><span class="s">&quot;h29v05&quot;</span><span class="p">)</span> <span class="c1">#list of tiles to download, they will be mosaiced and clipped later - format is important, see wget command below  </span>
 <span class="c1">### download HDFs  </span>
 <span class="c1">### Use wget to recursively download all files for selected tiles - will not overwrite unless source is newer  </span>
 searchstring<span class="o">=</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;\&quot;*&quot;</span><span class="p">,</span>tiles<span class="p">,</span><span class="s">&quot;*\&quot;&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>collapse<span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">)</span>  
  <span class="kp">system</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;wget -S --recursive --no-parent --no-directories -N -P&quot;</span><span class="p">,</span>hdffolder<span class="p">,</span><span class="s">&quot; --accept&quot;</span><span class="p">,</span>searchstring<span class="p">,</span><span class="s">&quot; --reject \&quot;*xml\&quot;&quot;</span><span class="p">,</span>ftpsite<span class="p">))</span></code></pre></div>

<p>This will put all the files in the hdffolder (which I set to “1_HDF”).  You now have each tile for time period as a separate file.  I find it convenient to mosaic the tiles and perhaps warp them to another projection and subset it to a smaller region than all of the tiles together.  To do this I use the following functions (note that some details are specific to extracting NDVI, if you want something else it will need to be edited).  The first converts a MODIS date code to the R date format:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">modday2date<span class="o">&lt;-</span><span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> <span class="kp">as.Date</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="kt">c</span><span class="p">(</span><span class="kp">substr</span><span class="p">(</span>i<span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">5</span><span class="p">),</span><span class="kp">substr</span><span class="p">(</span>i<span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="m">9</span><span class="p">)),</span>collapse<span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">),</span><span class="s">&quot;%Y-%j&quot;</span><span class="p">)</span></code></pre></div>

<p>The second converts a geotiff to a netcdf with a single-date record dimension:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">geotiff2netcdf<span class="o">=</span><span class="kr">function</span><span class="p">(</span>geotiff<span class="p">,</span>output<span class="p">,</span>date<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span>startday<span class="o">=</span><span class="kp">as.Date</span><span class="p">(</span><span class="s">&quot;2000-01-01&quot;</span><span class="p">),</span>varname<span class="o">=</span><span class="s">&quot;NDVI&quot;</span><span class="p">,</span>scale<span class="o">=</span><span class="m">0.0001</span><span class="p">,</span>missing<span class="o">=</span><span class="m">-3000</span><span class="p">,</span>range<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">)){</span>
  <span class="c1">## Create netcdf file from modistool geotiff output</span>
  <span class="c1">##create file and open for editing</span>
  <span class="c1">## convert Date</span>
  utdates<span class="o">=</span><span class="kp">as.numeric</span><span class="p">(</span><span class="kp">date</span><span class="o">-</span>startday<span class="p">)</span>
  <span class="c1">## Read in geotiff to set netCDF attributes</span>
  <span class="kp">print</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;Importing &quot;</span><span class="p">,</span>geotiff<span class="p">))</span>
  x<span class="o">=</span>readGDAL<span class="p">(</span>geotiff<span class="p">)</span>
  <span class="c1">## Set dimentions</span>
  <span class="kp">print</span><span class="p">(</span><span class="s">&quot;Defining NetCDF&quot;</span><span class="p">)</span>
  create.nc<span class="p">(</span>output<span class="p">,</span>clobber<span class="o">=</span><span class="bp">T</span><span class="p">)</span>
  nc<span class="o">=</span>open.nc<span class="p">(</span>output<span class="p">,</span>write<span class="o">=</span><span class="bp">T</span><span class="p">)</span> <span class="c1"># Opens connection with netcdf file and write permission</span>
  dim.def.nc<span class="p">(</span>nc<span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">,</span> dimlength<span class="o">=</span>x<span class="o">@</span>grid<span class="o">@</span>cells.dim<span class="p">[</span><span class="m">2</span><span class="p">],</span> unlim<span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
  dim.def.nc<span class="p">(</span>nc<span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">,</span> dimlength<span class="o">=</span>x<span class="o">@</span>grid<span class="o">@</span>cells.dim<span class="p">[</span><span class="m">1</span><span class="p">],</span> unlim<span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
  dim.def.nc<span class="p">(</span>nc<span class="p">,</span> <span class="s">&quot;time&quot;</span><span class="p">,</span> dimlength<span class="o">=</span><span class="kp">length</span><span class="p">(</span>utdates<span class="p">),</span> unlim<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
  var.def.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">,</span><span class="s">&quot;NC_SHORT&quot;</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">)</span>
  var.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">,</span>utdates<span class="p">,</span> start<span class="o">=</span><span class="kc">NA</span><span class="p">,</span> count<span class="o">=</span><span class="kc">NA</span><span class="p">,</span> na.mode<span class="o">=</span><span class="m">0</span><span class="p">)</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="s">&quot;units&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;days since &quot;</span><span class="p">,</span>startday<span class="p">,</span><span class="s">&quot; 0&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="s">&quot;standard_name&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">)</span>
  var.def.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;longitude&quot;</span><span class="p">,</span><span class="s">&quot;NC_DOUBLE&quot;</span><span class="p">,</span><span class="s">&quot;longitude&quot;</span><span class="p">)</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;longitude&quot;</span><span class="p">,</span> <span class="s">&quot;units&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span><span class="s">&quot;degrees_east&quot;</span><span class="p">)</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;longitude&quot;</span><span class="p">,</span> <span class="s">&quot;standard_name&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span><span class="s">&quot;longitude&quot;</span><span class="p">)</span>
  var.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;longitude&quot;</span><span class="p">,</span><span class="kp">seq</span><span class="p">(</span>x<span class="o">@</span>coords<span class="p">[</span><span class="m">1</span><span class="p">],</span>x<span class="o">@</span>coords<span class="p">[</span><span class="m">2</span><span class="p">],</span>x<span class="o">@</span>grid<span class="o">@</span>cellsize<span class="p">[</span><span class="m">1</span><span class="p">]),</span> start<span class="o">=</span><span class="kc">NA</span><span class="p">,</span> count<span class="o">=</span><span class="kc">NA</span><span class="p">,</span> na.mode<span class="o">=</span><span class="m">0</span><span class="p">)</span>
  var.def.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;latitude&quot;</span><span class="p">,</span><span class="s">&quot;NC_DOUBLE&quot;</span><span class="p">,</span><span class="s">&quot;latitude&quot;</span><span class="p">)</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;latitude&quot;</span><span class="p">,</span> <span class="s">&quot;units&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span><span class="s">&quot;degrees_north&quot;</span><span class="p">)</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;latitude&quot;</span><span class="p">,</span> <span class="s">&quot;standard_name&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span><span class="s">&quot;latitude&quot;</span><span class="p">)</span>
  var.put.nc<span class="p">(</span>nc<span class="p">,</span><span class="s">&quot;latitude&quot;</span><span class="p">,</span><span class="kp">seq</span><span class="p">(</span>x<span class="o">@</span>coords<span class="p">[</span><span class="m">3</span><span class="p">],</span>x<span class="o">@</span>coords<span class="p">[</span><span class="m">4</span><span class="p">],</span>x<span class="o">@</span>grid<span class="o">@</span>cellsize<span class="p">[</span><span class="m">2</span><span class="p">]),</span> start<span class="o">=</span><span class="kc">NA</span><span class="p">,</span> count<span class="o">=</span><span class="kc">NA</span><span class="p">,</span> na.mode<span class="o">=</span><span class="m">0</span><span class="p">)</span>
  var.def.nc<span class="p">(</span>nc<span class="p">,</span>varname<span class="p">,</span><span class="s">&quot;NC_SHORT&quot;</span><span class="p">,</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;longitude&quot;</span><span class="p">,</span><span class="s">&quot;latitude&quot;</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">))</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span>varname<span class="p">,</span> <span class="s">&quot;missing_value&quot;</span><span class="p">,</span><span class="s">&quot;NC_DOUBLE&quot;</span><span class="p">,</span><span class="kp">missing</span><span class="p">)</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span>varname<span class="p">,</span> <span class="s">&quot;units&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span>varname<span class="p">)</span>
  att.put.nc<span class="p">(</span>nc<span class="p">,</span>varname<span class="p">,</span> <span class="s">&quot;standard_name&quot;</span><span class="p">,</span><span class="s">&quot;NC_CHAR&quot;</span><span class="p">,</span>varname<span class="p">)</span>
  <span class="c1">## Process the data</span>
  <span class="kp">print</span><span class="p">(</span><span class="s">&quot;Processing data and writing to disk&quot;</span><span class="p">)</span>
  notnull<span class="o">=</span>x<span class="o">@</span>data<span class="o">!=</span><span class="kp">missing</span>
  x<span class="o">@</span>data<span class="p">[</span>notnull<span class="p">][</span>x<span class="o">@</span>data<span class="p">[</span>notnull<span class="p">]</span><span class="kp">range</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">/</span><span class="kp">scale</span><span class="p">]</span><span class="o">=</span>missing <span class="c1">#get rid of occasional weird value</span>
  <span class="c1">## write the data to netCDF file</span>
  var.put.nc<span class="p">(</span>nc<span class="p">,</span>varname<span class="p">,</span><span class="kp">as.matrix</span><span class="p">(</span>x<span class="p">)[,</span><span class="kp">ncol</span><span class="p">(</span><span class="kp">as.matrix</span><span class="p">(</span>x<span class="p">))</span><span class="o">:</span><span class="m">1</span><span class="p">],</span> start<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span>count<span class="o">=</span><span class="kt">c</span><span class="p">(</span>x<span class="o">@</span>grid<span class="o">@</span>cells.dim<span class="p">[</span><span class="m">1</span><span class="p">],</span>x<span class="o">@</span>grid<span class="o">@</span>cells.dim<span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="m">1</span><span class="p">))</span>
  close.nc<span class="p">(</span>nc<span class="p">)</span>
  <span class="kp">print</span><span class="p">(</span><span class="s">&quot;Finished!&quot;</span><span class="p">)</span>
 <span class="p">}</span></code></pre></div>

<p>And the third puts it all together by first using the mrtmosaic tool to mosaic the tiles and subset to the band of interest, then using resample tool (available at the link above) to convert the HDF to a geotiff and then calling the function above to convert that to a netCDF:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">### Function to procss the files using the commands above.  </span>
 modis2netcdf<span class="o">&lt;-</span><span class="kr">function</span><span class="p">(</span>i<span class="p">,</span>hdffolder<span class="p">,</span>outputfolder<span class="p">,</span>files<span class="p">,</span>bandsubset<span class="o">=</span><span class="m">1</span><span class="p">){</span>  
  tdir<span class="o">=</span><span class="s">&quot;/media/fynbos/public/tmp&quot;</span>  
  <span class="kp">dir.create</span><span class="p">(</span>tdir<span class="p">)</span>  
  tparams<span class="o">=</span><span class="kp">paste</span><span class="p">(</span>tdir<span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span>i<span class="p">,</span><span class="s">&quot;_params.txt&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>  
  tmos<span class="o">=</span><span class="kp">paste</span><span class="p">(</span>tdir<span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span>i<span class="p">,</span><span class="s">&quot;_mosaic.hdf&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>  
  tclip<span class="o">=</span><span class="kp">paste</span><span class="p">(</span>tdir<span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span>i<span class="p">,</span><span class="s">&quot;.tif&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>  
  ofile<span class="o">=</span><span class="kp">paste</span><span class="p">(</span>outputfolder<span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span>i<span class="p">,</span><span class="s">&quot;.nc&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>  
  f<span class="o">=</span><span class="kp">file.exists</span><span class="p">(</span>ofile<span class="p">)</span> <span class="c1"># file exists?  </span>
  <span class="kr">if</span><span class="p">(</span>f<span class="p">)</span> <span class="kp">print</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span>ofile<span class="p">,</span><span class="s">&quot; already exists, moving to next file....&quot;</span><span class="p">))</span>  <span class="c1"># if exists, stop  </span>
  <span class="kr">if</span><span class="p">(</span><span class="o">!</span>f<span class="p">)</span> <span class="p">{</span>  
  <span class="c1">## Mosaic and subset  </span>
   fs<span class="o">=</span><span class="kp">paste</span><span class="p">(</span>hdffolder<span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="kp">grep</span><span class="p">(</span>i<span class="p">,</span>files<span class="p">,</span>value<span class="o">=</span><span class="bp">T</span><span class="p">),</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>  
  write.table<span class="p">(</span>fs<span class="p">,</span>file<span class="o">=</span>tparams<span class="p">,</span>row.names<span class="o">=</span><span class="bp">F</span><span class="p">,</span>col.names<span class="o">=</span><span class="bp">F</span><span class="p">,</span>quote<span class="o">=</span><span class="bp">F</span><span class="p">)</span>  
  <span class="kp">system</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;mrtmosaic -i &quot;</span><span class="p">,</span>tparams<span class="p">,</span><span class="s">&quot; -s &quot;</span><span class="p">,</span>bandsubset<span class="p">,</span><span class="s">&quot; -o &quot;</span><span class="p">,</span>tmos<span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>  
  <span class="c1">## Clip and reproject  </span>
  <span class="kr">if</span><span class="p">(</span><span class="o">!</span><span class="kp">file.exists</span><span class="p">(</span><span class="s">&quot;ModisToolParams.prm&quot;</span><span class="p">))</span> <span class="p">{</span><span class="kp">print</span><span class="p">(</span><span class="s">&quot;Parameter file missing, stopping process&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="kp">stop</span><span class="p">}</span>  
  <span class="kp">system</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;resample -p ModisToolParams.prm -i &quot;</span><span class="p">,</span>tmos<span class="p">,</span><span class="s">&quot; -o &quot;</span><span class="p">,</span>tclip<span class="p">,</span><span class="s">&quot; -t GEO -l \&#39;&quot;</span><span class="p">,</span>regionbounds<span class="p">,</span><span class="s">&quot;\&#39; -a INPUT_LAT_LONG -r CC&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>  
  geotiff<span class="o">=</span><span class="kp">paste</span><span class="p">(</span>tdir<span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span>i<span class="p">,</span><span class="s">&quot;.250m_16_days_NDVI.tif&quot;</span><span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>  
  geotiff2netcdf<span class="p">(</span>geotiff<span class="p">,</span>output<span class="o">=</span>ofile<span class="p">,</span>date<span class="o">=</span>modday2date<span class="p">(</span>i<span class="p">))</span>  
  <span class="kp">file.remove</span><span class="p">(</span>tmos<span class="p">,</span>tclip<span class="p">,</span>tparams<span class="p">);</span> <span class="kp">gc</span><span class="p">()</span>  
  <span class="kp">print</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="kp">which</span><span class="p">(</span>dates<span class="o">%in%</span>i<span class="p">),</span> <span class="s">&quot;out of &quot;</span><span class="p">,</span> <span class="kp">length</span><span class="p">(</span>dates<span class="p">)))</span>  
 <span class="p">}}</span></code></pre></div>

<p>You can then run these functions to process a folder of HDF files with the following commands.  If you are on a *nix system with multiple cores, I recommend using the multicore package to parallelize the processing.  Otherwise you’ll need to change the mclapply() below to lapply():</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">allfiles<span class="o">=</span><span class="kp">as.character</span><span class="p">(</span><span class="kp">list.files</span><span class="p">(</span>path <span class="o">=</span> <span class="kp">paste</span><span class="p">(</span><span class="kp">getwd</span><span class="p">(),</span>hdffolder<span class="p">,</span>sep<span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">)))</span> <span class="c1"># build file list  </span>
 dates<span class="o">=</span><span class="kp">unique</span><span class="p">(</span><span class="kp">do.call</span><span class="p">(</span><span class="s">&quot;rbind&quot;</span><span class="p">,</span><span class="kp">strsplit</span><span class="p">(</span>allfiles<span class="p">,</span><span class="s">&quot;.&quot;</span><span class="p">,</span>fixed<span class="o">=</span><span class="bp">T</span><span class="p">))[,</span><span class="m">2</span><span class="p">])</span> <span class="c1">#get unique dates  </span>
 type<span class="o">=</span><span class="kp">do.call</span><span class="p">(</span><span class="s">&quot;rbind&quot;</span><span class="p">,</span><span class="kp">strsplit</span><span class="p">(</span>allfiles<span class="p">,</span><span class="s">&quot;.&quot;</span><span class="p">,</span>fixed<span class="o">=</span><span class="bp">T</span><span class="p">))[</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">]</span> <span class="c1">#get prefix of file type  </span>
 band<span class="o">=</span><span class="m">1</span>  
 <span class="c1">### Run the files - will not overwrite existing mosaics  </span>
 mclapply<span class="p">(</span>dates<span class="p">,</span>modis2netcdf<span class="p">,</span>hdffolder<span class="p">,</span>outputfolder<span class="o">=</span>ofolder<span class="p">,</span>files<span class="o">=</span>allfiles<span class="p">,</span>bandsubset<span class="o">=</span>band<span class="p">,</span>mc.cores<span class="o">=</span><span class="m">8</span><span class="p">,</span>mc.preschedule<span class="o">=</span><span class="bp">F</span><span class="p">)</span></code></pre></div>

<p>Now you can use the NCO commands to extract a timeseries from these files, perhaps for only a subset of the data using ncrcat.</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'planetflux'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://adammwilson.github.io//blog/Conservation-Biology-in-Morocco/" class="btn" title="Conservation Biology in Morocco">Previous</a>
      
      
        <a href="http://adammwilson.github.io//blog/copy-all-the-files-in-a-directory-to-a-new-directory-using-r/" class="btn" title="Copy all the files in a directory to a new directory using R">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2015 Adam M. Wilson. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/planetflux" title="Adam M. Wilson on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	<a href="http://plus.google.com/+adammichaelwilson" title="Adam M. Wilson on Google+" target="_blank"><i class="fa fa-google-plus-square fa-2x"></i></a>
	
	
	
	
	<a href="http://github.com/adammwilson" title="Adam M. Wilson on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="http://adammwilson.github.io//feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->
  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://adammwilson.github.io/';
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://adammwilson.github.io//assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://adammwilson.github.io//assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-2684666-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

	        

</body>
</html>
